---
// definimos el tipo de las propiedades
type AreaCampusProps = {
    campusList: { campus_id: number; campus_name: string }[]; // lista de campus
    areaList: { area_id: number; area_name: string }[]; // lista de areas
};

// Extraemos las propiedades
const { campusList = [], areaList = [] } = Astro.props as AreaCampusProps;
---
<!-- alerta de error -->
<div id="userform-alert" class="hidden p-3 rounded-lg mb-3"></div>

<!-- formulario de usuario -->
<form id="userform" class="space-y-4">
    <input type="text" name="names" placeholder="Nombres" required class="border p-2 w-full rounded"
            maxlength="60" pattern="[A-Za-zÁÉÍÓÚáéíóúÑñÜü ']{2,60}"/>
    <input type="text" name="last_name_1" placeholder="Apellido paterno" required class="border p-2 w-full rounded" 
            maxlength="60" pattern="[A-Za-zÁÉÍÓÚáéíóúÑñÜü ']{2,60}"/>
    <input type="text" name="last_name_2" placeholder="Apellido materno (opcional)" class="border p-2 w-full rounded"  
            maxlength="60" pattern="[A-Za-zÁÉÍÓÚáéíóúÑñÜü ']{2,60}"/>
    <input type="email" name="email" placeholder="Email" required class="border p-2 w-full rounded" />
    <input type="password" name="password" placeholder="Contraseña (mín. 6)" required minlength="6" class="border p-2 w-full rounded" />

    <select name="role" required class="border p-2 w-full rounded">
        <option value="user">Usuario</option>
        <option value="admin">Administrador</option>
        <option value="manager">Manager</option>
    </select>

    <select name="status" required class="border p-2 w-full rounded">
        <option value="active">Activo</option>
        <option value="inactive">Inactivo</option>
        <option value="pending">Pendiente</option>
    </select>

    {/* Seleccionar Área */}
    <select name="area_id" class="border p-2 w-full rounded">
        <option value="">Seleccionar Área</option>
        {areaList.map((a: any) => (
            <option value={a.area_id}>
                {a.area_name}
            </option>
        ))}
    </select>
    
    {/* Seleccionar Campus */}
    <select name="campus_id" class="border p-2 w-full rounded">
        <option value="">Seleccionar Campus</option>
        {campusList.map((c: any) => (
            <option value={c.campus_id}>
                {c.campus_name}
            </option>
        ))}
    </select>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded align-center w-full hover:bg-blue-700">
        Crear Usuario
    </button>
</form>


<script is:inline>
    // referenciamos el formulario y alerta
    const form = document.getElementById('userform');
    const alertBox = document.getElementById('userform-alert');

    // Permite letras Unicode, marcas combinadas, espacios y apóstrofe
    const nameRegex = /^[\p{L}\p{M} ']{2,60}$/u;

    const norm = (s) => (s ?? "")
            .toString()
            .normalize("NFC")
            // deja solo letras, espacios y apóstrofe
            .replace(/[^\p{L}\p{M} ']/gu, "")
            // colapsa espacios múltiples a uno solo
            .replace(/ {2,}/g, " ")
            .trim()
            .slice(0, Name_Max)

    // funcion para mostrar alertas
    function showAlert(msg, type = 'success') {
        alertBox.textContent = msg; // mensaje de alerta
        alertBox.className = 'p-3 rounded-lg mb-3 ' + (type === 'success' 
        ? 'bg-green-50 text-green-800' // exito
        : 'bg-red-50 text-red-800'); // error
        alertBox.classList.remove('hidden'); // mostrar alerta
    }
    
    // funcion para verificar si el valor es undefined, nulo o vacio
    function isNullOrEmpty(value) {
        return value === '' || value === null || value === 'undefined';
    }

    // manejador del envio del formulario
    form?.addEventListener('submit', async (e) => {  // capturamos el evento
        e.preventDefault(); // prevenimos el envio del formulario
        // var para deshabilitar el boton de envio
        const button = e.currentTarget.querySelector('button[type="submit"]');

        alertBox.classList.add('hidden'); // ocultamos alertas
        alertBox.textContent = ''; // limpiamos mensaje
        if (button) button.disabled = true; // deshabilita el boton

        // var de los datos del formulario
        const fd = new FormData(form);        
        const areaIdValue = fd.get('area_id'); // obtenemos el area del formulario
        const campusIdValue = fd.get('campus_id'); // lo mismo con campus

        // payload para la api
        const payload = {
            names: fd.get('names'),
            last_name_1: fd.get('last_name_1'),
            last_name_2: fd.get('last_name_2') || '',

            email: fd.get('email'),
            password: fd.get('password'),

            role: fd.get('role') || 'user',
            status: fd.get('status') || 'active',

            // si el valor es vacío o null, enviamos null (lo que zod espera para campos nullable)
            area_id: isNullOrEmpty(areaIdValue) ? null : Number(areaIdValue), 
            campus_id: isNullOrEmpty(campusIdValue) ? null : Number(campusIdValue),

        };

        // validar payload
        if (!nameRegex.test(norm(payload.names))) {
            showAlert('El campo Nombres es inválido. Solo se permiten letras y espacios.', 'error');
            if (button) button.disabled = false; // Reactiva el botón
            return;
        }

        if (!nameRegex.test(norm(payload.last_name_1))) {
            showAlert('El campo Apellido paterno es inválid. Solo se permiten letras y espacios', 'error');
            if (button) button.disabled = false; // Reactiva el botón
            return;
        }

        if (!nameRegex.test(norm(payload.last_name_2))) {
            showAlert('El campo Apellido materno es inválido. Solo se permiten letras y espacios', 'error');
            if (button) button.disabled = false; // Reactiva el botón
            return;
        }


        try {
            const res = await fetch('/api/auth/register', {  // llamada de la api
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, // indicamos que es json
                body: JSON.stringify(payload), // enviamos el payload
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data?.ok) {
                const msg = data?.message || 'No se pudo crear el usuario';
                showAlert(msg, 'error');
                return;
            }

            showAlert('Usuario creado con éxito', 'success');
            form.reset();

            // Recargar la tabla de usuarios
            location.reload();
        } catch (err) {
            showAlert('Error de red: ' + (err?.message || err), 'error');
        } finally {
            if (button) button.disabled = false; // Reactiva el botón
        }
    });
    
</script>