---
import { createServerSupabase } from '@/lib/supabase/supabaseServer';

// obtener sesion y perfil
const supabase = await createServerSupabase({ request: Astro.request, cookies: Astro.cookies });

// obtener usuario actual
const { data: userData, error: userError } = await supabase.auth.getUser();
const user = userData?.user ?? null; // var del usuario auth
let userRole = null; // var de rol

// consulta de rol si el usuario existe
if (user) {
        const { data: profile } = await supabase
                .from("user_profiles")
                .select("role")
                .eq("user_id", user.id)
                .maybeSingle();
        // asignacion de rol
        userRole = profile?.role ?? null;
}


// // para debug
// console.log("[Sidebar] user:", user);
// console.log("[Sidebar] profile:", profile);
// if (!user) {
//     console.warn("[Sidebar] Usuario no autenticado.");
// }

const pathname = Astro.url.pathname; // obtenemos la ruta actual
const isActive = (href: string) => pathname === href; // verificar si la ruta existe

// La clase base en el HTML
const baseLink = "flex items-center p-2 rounded-lg group"; 
---
<aside id="logo-sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen pt-20 transition-transform -translate-x-full sm:translate-x-0 rounded" style="background-color:#06335C;" aria-label="Sidebar">
    <div class="h-full px-3 pb-4 overflow-y-auto" style="background-color:#06335C;">
        <ul class="space-y-2 font-medium">

            {/* Dashboard*/}
            <li>
                <a href="/" class={`${baseLink} ${isActive('/') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-white group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15v4m6-6v6m6-4v4m6-6v6M3 11l6-5 6 5 5.5-5.5"/>
                    </svg>
                    <span class="ms-3">Panorama General</span>
                </a>
            </li>
            
            {/* Vistas Comunas*/}
            <li>
                <a href="/views/comunas" class={`${baseLink} ${isActive('/views/comunas') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M11.906 1.994a8.002 8.002 0 0 1 8.09 8.421 7.996 7.996 0 0 1-1.297 3.957.996.996 0 0 1-.133.204l-.108.129c-.178.243-.37.477-.573.699l-5.112 6.224a1 1 0 0 1-1.545 0L5.982 15.26l-.002-.002a18.146 18.146 0 0 1-.309-.38l-.133-.163a.999.999 0 0 1-.13-.202 7.995 7.995 0 0 1 6.498-12.518ZM15 9.997a3 3 0 1 1-5.999 0 3 3 0 0 1 5.999 0Z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3">Segmentaci칩n Geogr치fica</span>
                </a>
            </li>
            
            {/* Vistas Colegio*/}
            <li>
                <a href="/views/colegios" class={`${baseLink} ${isActive('/views/colegios') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12.4472 4.10557c-.2815-.14076-.6129-.14076-.8944 0L2.76981 8.49706l9.21949 4.39024L21 8.38195l-8.5528-4.27638Z"/>
                        <path d="M5 17.2222v-5.448l6.5701 3.1286c.278.1325.6016.1293.8771-.0084L19 11.618v5.6042c0 .2857-.1229.5583-.3364.7481l-.0025.0022-.0041.0036-.0103.009-.0119.0101-.0181.0152c-.024.02-.0562.0462-.0965.0776-.0807.0627-.1942.1465-.3405.2441-.2926.195-.7171.4455-1.2736.6928C15.7905 19.5208 14.1527 20 12 20c-2.15265 0-3.79045-.4792-4.90614-.9751-.5565-.2473-.98098-.4978-1.27356-.6928-.14631-.0976-.2598-.1814-.34049-.2441-.04036-.0314-.07254-.0576-.09656-.0776-.01201-.01-.02198-.0185-.02991-.0253l-.01038-.009-.00404-.0036-.00174-.0015-.0008-.0007s-.00004 0 .00978-.0112l-.00009-.0012-.01043.0117C5.12215 17.7799 5 17.5079 5 17.2222Zm-3-6.8765 2 .9523V17c0 .5523-.44772 1-1 1s-1-.4477-1-1v-6.6543Z"/>
                    </svg>
                    <span class="ms-3">Segmentaci칩n por Establecimientos</span>
                </a>
            </li>

            {/* Vista Industria*/}
            <li>
                <a href="/views/industria" class={`${baseLink} ${isActive('/views/industria') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path fill-rule="evenodd" d="M4 4a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2v14a1 1 0 1 1 0 2H5a1 1 0 1 1 0-2V5a1 1 0 0 1-1-1Zm5 2a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H9Zm5 0a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1h-1Zm-5 4a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1H9Zm5 0a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-1Zm-3 4a2 2 0 0 0-2 2v3h2v-3h2v3h2v-3a2 2 0 0 0-2-2h-2Z" clip-rule="evenodd"/>
                </svg>
                    <span class="ms-3">Segmentaci칩n por Industria</span>
                </a>
            </li>

            {/* Visitas*/}
            <li>
                <a href="/views/visitas/list-visitas" class={`${baseLink} ${isActive('/views/visitas/list-visitas') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.5 11.5 11 14l4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                    </svg>
                    <span class="ms-3">Visitas a Colegios</span>
                </a>
            </li>

                {/* Gestion de usuarios */}
            { (userRole === 'admin' || userRole === 'manager') && (<li>
                        <a href="/user"
                        class={`${baseLink} ${isActive('/user') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                        <svg class="w-5 h-5 text-white group-hover:text-white" viewBox="0 0 20 18" fill="currentColor"><path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/></svg>
                        <span class="ms-3">Usuarios</span>
                        </a>
                </li>)}

                {/* Registros */}
            { (userRole === 'admin' || userRole === 'manager') && (<li>
                <a href="/logs" class={`${baseLink} ${isActive('/logs') ? 'bg-blue-500 text-white' : 'text-white hover:bg-blue-700'}`}>
                    <svg class="w-6 h-6 text-white group-hover:text-white" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9 7V2.221a2 2 0 0 0-.5.365L4.586 6.5a2 2 0 0 0-.365.5H9Zm2 0V2h7a2 2 0 0 1 2 2v9.293l-2-2a1 1 0 0 0-1.414 1.414l.293.293h-6.586a1 1 0 1 0 0 2h6.586l-.293.293A1 1 0 0 0 18 16.707l2-2V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9h5a2 2 0 0 0 2-2Z" clip-rule="evenodd"/></svg>
                    <span class="ms-3">Registros</span>
                </a>
            </li>)}

        </ul>
    </div>
</aside>
